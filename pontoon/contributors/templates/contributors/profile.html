{% import "insights/widgets/tooltip.html" as Tooltip %}

{% extends "base.html" %}

{% block title %}{{ contributor.name_or_email }}{% endblock %}

{% block class %}user{% endblock %}

{% block bottom %}
<section id="main" class="clearfix">
    <div class="container clearfix">
        <div class="left-column">

            {% set is_my_profile = (user.is_authenticated and user.email == contributor.email) %}
            {% set profile = contributor.profile %}

            <a class="avatar" href="{% if is_my_profile %}https://gravatar.com/{% endif %}">
                {% if is_my_profile %}
                <div class="desc">Change your profile picture</div>
                {% endif %}
                <img class="rounded" src="{{ contributor.gravatar_url(544) }}" width="272" height="272">
            </a>

            <div class="personal-information">
                {% set is_name_visible = contributor.first_name or profile.username %}
                {% if is_name_visible %}
                <div class="block">
                    {% if contributor.first_name %}
                    <h2 class="display-name">{{ contributor.first_name }}</h2>
                    {% endif %}
                    {% if profile.username %}
                    <div class="username">{{ profile.username }}</div>
                    {% endif %}
                </div>
                {% endif %}

                {% if profile.bio %}
                <div class="block">
                    <div class="bio">{{ profile.bio }}</div>
                </div>
                {% endif %}

                {% set is_email_visible = user.is_authenticated and (profile.visibility_email == "Logged in users" or user.translated_locales or contributor.manager_for_locales or contact_for.exists() or contributor.is_superuser) %}
                {% set are_external_accounts_visible = (profile.visibility_external_accounts == "Public" or user.translated_locales) and (profile.chat or profile.github or profile.bugzilla) %}

                {% if is_email_visible or are_external_accounts_visible %}
                <div class="block">
                    {% if is_email_visible %}
                    {% set email = profile.contact_email or contributor.email %}
                    <div class="item-with-icon">
                        <span class="icon fa fa-envelope"></span>
                        <a href="mailto:{{ email|nospam }}">{{ email|nospam }}</a>
                    </div>
                    {% endif %}

                    {% if are_external_accounts_visible %}

                    {% if profile.chat %}
                    <div class="item-with-icon" title="Chat Account">
                        <span class="icon fa fa-comment-dots"></span>
                        <span>{{ profile.chat }}</span>
                    </div>
                    {% endif %}

                    {% if profile.github %}
                    <div class="item-with-icon" title="GitHub Account">
                        <span class="icon fab fa-github"></span>
                        <a href="https://github.com/{{ profile.github }}">{{ profile.github }}</a>
                    </div>
                    {% endif %}

                    {% if profile.bugzilla %}
                    <div class="item-with-icon" title="Bugzilla Account">
                        <span class="icon fa fa-bug"></span>
                        <a href="mailto:{{ profile.bugzilla|nospam }}">{{ profile.bugzilla|nospam }}</a>
                    </div>
                    {% endif %}

                    {% endif %}
                </div>
                {% endif %}

                {% if is_my_profile %}
                <div class="block">
                    <a class="button" href="{{ url('pontoon.contributors.settings') }}">Change Settings</a>
                </div>
                {% endif %}
            </div>

            {% if is_name_visible or profile.bio or is_email_visible or are_external_accounts_visible or is_my_profile %}
            <hr>
            {% endif %}

            <div class="dates">
                <div class="block">
                    <h4 class="subtitle">Latest activity</h4>
                    <div class="item-with-icon">
                        <span class="icon fa fa-calendar-alt"></span>
                        {% set action = contributor.latest_action %}
                        {% if action and action.translation %}
                        {% set resource = action.translation.entity.resource %}
                        {% set string = action.translation.entity.pk %}
                        <a href="{{ url('pontoon.translate', action.translation.locale.code, resource.project.slug, resource.path) }}?string={{ string }}">{{ action.created_at|format_datetime("date") }}</a>
                        {% else %}
                        <span>No activity yet</span>
                        {% endif %}
                    </div>
                </div>

                <div class="block">
                    <h4 class="subtitle">Last login</h4>
                    <div class="item-with-icon">
                        <span class="icon fa fa-calendar-alt"></span>
                        <span>{{ contributor.last_login|format_datetime("date") }}</span>
                    </div>
                </div>

                <div class="block">
                    <h4 class="subtitle">Member since</h4>
                    <div class="item-with-icon">
                        <span class="icon fa fa-calendar-alt"></span>
                        <span>{{ contributor.date_joined|format_datetime("date") }}</span>
                    </div>
                </div>
            </div>

            {% if contributor.translator_for_locales or contributor.manager_for_locales or contact_for.exists() %}
            <hr>
            {% endif %}

            <div class="permissions">
                {% if contributor.translator_for_locales %}
                <div class="block">
                    <h4 class="subtitle">Translator</h4>
                    {% for locale in contributor.translator_for_locales %}
                    <div class="item-with-icon">
                        <span class="icon fa fa-language"></span>
                        <span>{{ locale.name }} <span class="stress">{{ locale.code }}</span></span>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {% if contributor.manager_for_locales %}
                <div class="block">
                    <h4 class="subtitle">Team manager</h4>
                    {% for locale in contributor.manager_for_locales %}
                    <div class="item-with-icon">
                        <span class="icon fa fa-language"></span>
                        <a href="{{ url('pontoon.teams.team', locale.code) }}">{{ locale.name }} <span class="stress">{{ locale.code }}</span></a>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {% if contact_for.exists() %}
                <div class="block">
                    <h4 class="subtitle">Project manager</h4>
                    {% for project in contact_for %}
                    <div class="item-with-icon">
                        <span class="icon fa fa-language"></span>
                        <a href="{{ url('pontoon.projects.project', project.slug) }}">{{ project.name }}</a>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

        </div>

        <div class="right-column">

            {% set approval_ratio_visibile = profile.visibility_approval == "Public" or user.translated_locales %}
            {% set self_approval_ratio_visibile = profile.visibility_self_approval == "Public" or user.translated_locales %}
            {% if approval_ratio_visibile or self_approval_ratio_visibile %}
            <section id="insights" class="half" data-dates="{{ dates }}">
                <div class="block clearfix">
                    <div class="chart-group">
                        {% if approval_ratio_visibile %}
                        <div class="chart-item approval-ratio">
                            <h3 class="controls">
                                Approval ratio
                                {{ Tooltip.display(
                                    items=[{
                                        'class': 'current-month',
                                        'name': 'Current month',
                                        'definition': 'Ratio of translations approved within all translations reviewed during each month.',
                                    }, {
                                        'class': 'twelve-month-average',
                                        'name': '12-month average',
                                        'definition': 'Ratio of translations approved within all translations reviewed in the 12 months before the specific month.',
                                    }]
                                ) }}
                            </h3>
                            <canvas
                                id="approval-ratio-chart"
                                data-approval-ratios="{{ approval_ratios }}"
                                data-approval-ratios-12-month-avg="{{ approval_ratios_12_month_avg }}"
                                width="420"
                                height="{% if self_approval_ratio_visibile %}159{% else %}191{% endif %}">
                            </canvas>
                        </div>
                        {% endif %}
                        {% if self_approval_ratio_visibile %}
                        <div class="chart-item self-approval-ratio">
                            <h3 class="controls">
                                Self-approval ratio
                                {{ Tooltip.display(
                                    items=[{
                                        'class': 'current-month',
                                        'name': 'Current month',
                                        'definition': 'Ratio of self-approved translations within all approved translations during each month.',
                                    }, {
                                        'class': 'twelve-month-average',
                                        'name': '12-month average',
                                        'definition': 'Ratio of self-approved translations within all approved translations in the 12 months before the specific month.',
                                    }]
                                ) }}
                            </h3>
                            <canvas
                                id="self-approval-ratio-chart"
                                data-self-approval-ratios="{{ self_approval_ratios }}"
                                data-self-approval-ratios-12-month-avg="{{ self_approval_ratios_12_month_avg }}"
                                width="420"
                                height="{% if approval_ratio_visibile %}159{% else %}191{% endif %}">
                            </canvas>
                        </div>
                        {% endif %}
                    </div>
                    {% if approval_ratio_visibile and self_approval_ratio_visibile %}
                    <nav class="chart-group-navigation">
                        <ul class="unselectable">
                            <li class="active" title="Approval ratio">
                                <i class="icon"></i><span class="label">Approval ratio</span>
                            </li>
                            <li title="Self-approval ratio">
                                <i class="icon"></i><span class="label">Self-approval ratio</span>
                            </li>
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </section>
            {% endif %}

            <section id="stats">
                <div class="total">
                    <span>All translations</span>
                    <p>{{ translations.count()|intcomma }}</p>
                </div>
                <div class="translated">
                    <span>Approved</span>
                    <p>{{ translations.filter(approved=True).count()|intcomma }}</p>
                </div>
                <div class="unreviewed">
                    <span>Unreviewed</span>
                    <p>{{ translations.exclude(approved=True).exclude(rejected=True).count()|intcomma }}</p>
                </div>
            </section>

        </div>
    </div>
</section>
{% endblock %}

{% block extend_css %}
{% stylesheet 'profile' %}
{% endblock %}

{% block extend_js %}
{% javascript 'profile' %}
{% endblock %}
