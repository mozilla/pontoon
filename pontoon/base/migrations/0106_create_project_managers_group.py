# Generated by Django 4.2.27 on 2026-01-31 16:21

from django.db import migrations


def create_pm_group(apps, schema_editor):
    # 1. Get the models we need from the historical state
    Group = apps.get_model("auth", "Group")
    Permission = apps.get_model("auth", "Permission")
    ContentType = apps.get_model("contenttypes", "ContentType")
    Project = apps.get_model("base", "Project")

    # 2. Get or Create the 'project_managers' group
    group, created = Group.objects.get_or_create(name="project_managers")
    if created:
        print("Created 'project_managers' group.")
    else:
        print("'project_managers' group already exists.")

    # 3. Fetch the permission declared on Project.Meta.permissions
    project_content_type = ContentType.objects.get(app_label="base", model="project")

        permission = Permission.objects.get(
        codename="can_manage_project",
        content_type=project_content_type,
    )

    # 4. Assign the permission to the group
    # We use .add() which handles duplicates gracefully
    group.permissions.add(permission)
    print(f"Added 'can_manage_project' permission to {group.name}")


def remove_pm_group(apps, schema_editor):
    # Reversal: Delete the group if we un-migrate
    Group = apps.get_model("auth", "Group")
    Group.objects.filter(name="project_managers").delete()


class Migration(migrations.Migration):
    dependencies = [
        ("base", "0105_fix_mf2_translations"),
        ("auth", "0001_initial"),
        ("contenttypes", "0001_initial"),
    ]

    operations = [
        migrations.RunPython(create_pm_group, remove_pm_group),
    ]
